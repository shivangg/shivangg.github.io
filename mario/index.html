<!-- ====================================Algo for mario to make it big. Use webkit animation, design 100x50 SID. -->


<html>
<audio id="theme1" src="sounds/game.mp3" onended="theme1End()"></audio>
<body onkeydown="keyDown(event)" onkeyup="keyUp(event)">
<canvas id="gameArea" width="600" height="400" 
	style="
		position:absolute;
		background-image: url(images/background.jpg);
		background-size: 5000px 400px;
		overflow:				hidden;
		">
</canvas>
	<script>
    var gameCanvas=document.getElementById("gameArea");		//node of gameArea canvas
    var grafx=gameCanvas.getContext("2d");					//to call all functions defined for canvas
    var ground=new generator("images/greenPump.jpg",20,20,50,50,"ground");	//just to make a dummy generator
    var dead=false;
    var player=new generator("images/fb.jpg",250,100,50,50,dead);
    var sndJump=new Audio("sounds/jump.wav");
    var theme1=document.getElementById("theme1");
    var sndDie=new Audio("sounds/mariodie.wav");
    var sndStomp=new Audio("sounds/stomp.wav");
    theme1.play();
    function theme1End(){
    	theme1.play();
    }
    
    var maxBlock=100;						//decide total number of blocks in the game
    
    for (var i = 0; i<=maxBlock-1; i++) {
    	if (i%2!=0) 
    		ground[i]=new generator("images/ground.jpg",i*50+Math.floor(Math.random()*50),350+10000*Math.floor(2*Math.random()),50,50,"ground");	//x only 4units//y upto 2 units random stage
    	else if (i%6==0)
    		ground[i]=new generator("images/questionMark.gif",i*Math.floor(Math.random()*4)*55+100,Math.floor(6-Math.random()*3)*55,50,50,"question");
    	else
    		ground[i]=new generator("images/Goomba.gif",i*Math.floor(Math.random()*4)*55+100,Math.floor(6-Math.random()*3)*55,50,50,"animal");
	}
	ground[maxBlock]=new generator("images/ground.jpg",250,350,50,50,"ground");		//to always have a ground below player upon initialisation
	
	var isLeft=false;
	var isRight=false;
	var isSpace=false;
	player.maxSpeed=20;
	player.Weight=0.2;

//events
function keyDown (e)
	{
	if(String.fromCharCode(e.keyCode)=="%") isLeft=true; //for left
	if(String.fromCharCode(e.keyCode)=="'") isRight=true; /* player.Image.img="images/Mario Running.gif"*/		//for right
	if(String.fromCharCode(e.keyCode)==" ") isSpace=true;
	}
function keyUp (e) 
	{
	if(String.fromCharCode(e.keyCode)=="%") isLeft=false; //for left
	if(String.fromCharCode(e.keyCode)=="'") isRight=false; /*player.Image.img="images/Mario Standing.gif"*/	//for right
	if(String.fromCharCode(e.keyCode)==" ") isSpace=false;
	}

//MAIN LOOP
MainLoop();

//for background scrolling
var background_X=0;
var backgroundVelocityX=0;

function MainLoop () {
	//pre variable adjustments
	for(var i=0;i<=maxBlock;i++) ground[i].X+=-player.Velocity_X;		//To move background backward only in X direction
	player.Y+=player.Velocity_Y;										//No such thing for Y direction
	if(player.Velocity_X) background_X+=backgroundVelocityX;			//move only when mario moving
	//console.log(player.Velocity_Y);

	gameArea.style.backgroundPosition=background_X+"px"+" 0px";

	//logic
	
	if(isLeft) 
		{
			backgroundVelocityX=0.2;	//very slow blackground scroll
			player.Velocity_X= -3;
			
		}
	if(isRight)
		{
			backgroundVelocityX=-0.2;
			player.Velocity_X= 3;
			//gameArea.style.backgroundPosition=	(backgroundX)+"px"+" 0px";
		}

	if(!isRight && !isLeft && player.Velocity_Y==0)
		{
			player.Velocity_X=0;	//to stop the player. Stops only when on ground
			backgroundVelocityX=0;	//to stop movving background from moving
		}

	//DIE utility
	if(player.Y>800) dead=true;
	if(dead)
		{
			//player.Y=325;
			player.Image.src="images/gplus.jpg";
			dead=false;
			player.Velocity_Y=-18;//jump before die
			theme1.pause();	//stop background theme
			sndDie.play();	//play die sound
			player.Velocity_X=0;
			setTimeout(function(){ 
			window.location.href = window.location.pathname;
				},2500);	//to refresh after Game over tune is over
		}

	
	//To get accelerated drop of player(GRAVITY EFFECT)
	if(player.Velocity_Y<player.maxSpeed)
		{
			player.Velocity_Y+=player.Weight;
		}




		//colliding LOGIC




	for(var i=0;i<=maxBlock;i++)
	{
			if(player.isColliding(ground[i]))
			{
							//Top colliding
			if((player.Y+player.Height>ground[i].Y)&&(player.Y+player.Height-12<ground[i].Y))	//TOLERATE limits of 12 to handle for accelerated velocity y
				{
					player.Y=(ground[i].Y)-(player.Height);
					player.Velocity_Y=0;
					//console.log("colliding top");
					if (ground[i].Reactive=="animal") 
						{						
							ground[i].Y=1000;				//to throw away the reactive animal
							player.Velocity_Y=-3;			//to jump a little after killing the reactive animal
							sndStomp.play();
						}
				}



			//Bottom colliding
			if((player.Y<ground[i].Height+ground[i].Y)&&(player.Y+12>ground[i].Height+ground[i].Y))		
			{

				if(ground[i].Reactive=="animal") dead=true;
				//console.log("colliding from below");
				player.Velocity_Y=3;			//to refect back
				

				
				if (ground[i].Reactive=="question") //&& ground[i].Image.src=="images/questionMark.gif"
				{
					//console.log("colliding the reactive generator from below");
					//console.log(player.Y+" + "+player.Height+" < "+ground[i].Y+" + "+player.Velocity_Y);
					player.Y=(ground[i].Y)+(ground[i].Height);
					ground[i].Image.src="images/blank.png";		//to remove the glow of question mark if player collides from bottom
					ground[i].Reactive="diffused";							//to makee it lose reactivity after getting point
					sndStomp.play();
						
				}
			}

			
			//Moving right,colliding from left of obstacle
			if((player.X+player.Width>ground[i].X)&&((player.X+player.Width-4<ground[i].X))&&(player.Velocity_Y))	
				{
					//console.log("colliding from left");
					//console.log(player.Velocity_X);
					player.Velocity_X=0;
					if (ground[i].Reactive=="animal") dead=true;
				}
			//Moving left, colliding from right of obstacle
			if((player.X>ground[i].X+ground[i].Width)&&((player.X-4<ground[i].X)+ground[i].Width)&&(player.Velocity_Y))	
				{
					//console.log("colliding from right");
					//console.log(player.Velocity_X);
					player.Velocity_X=0;
					if(ground[i].Reactive=="animal") dead=true;		
				}
			}
	}

	if(isSpace&&player.Velocity_Y==0)	//jump only on spacebar and when on ground
		{
			player.Velocity_Y=-8;	//to get jump by decreasing Y coordinates
			sndJump.play();	//to play jump music on jump.
		}

	//draw on canvas	
	grafx.clearRect(0,0,gameCanvas.width,gameCanvas.height);		//to clear previous state of canvas

	
	for(var i=0;i<=maxBlock;i++)									//finally draw the obstacles

	grafx.drawImage(ground[i].Image,ground[i].X,ground[i].Y);

	//IMPORTANT THE LATER YOU DRAW THE generator OBJECT, MORE IS ITS Z-INDEX.
	grafx.drawImage(player.Image,player.X,player.Y);//last thing drawn has lowest death	//draw the player MARIO
	setTimeout(MainLoop,15);
	
}

function generator(img,x,y,width,height,reactive)
	{
		this.Image=document.createElement("img");	//DOM method to create img element
		this.Image.src=img;		//specify image path
		this.Height=height;
		this.Width=width;
		this.X=x;
		this.Y=y;
		this.Reactive=reactive;
		this.Velocity_X=0;
		this.Velocity_Y=0;
		this.maxSpeed=0;
		this.Weight=0;
		this.isColliding=function(obj)
		{
			if(this.Y+this.Height<obj.Y) return false;	//colliding from above obstacle
			if(this.Y>obj.Y+obj.Height) return false;	//colliding from below obstacle
			if(this.X>obj.X+obj.Width) return false;	//colliding from right side
			if(this.X+this.Width<obj.X) return false;	//colliding from left side
			return true;
		}
	}



</script>
</body>
</html>